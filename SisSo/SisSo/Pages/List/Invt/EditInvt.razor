@inherits FrmListBaseComponent

<div class="w-100">
    <FormList Title="@Title" @bind-curActionTask="@curActionTask" OnSave="@SaveDM" OnEdit="@OnEdit" OnCopy="@OnCopy" OnCancel="@HideVoucher">
        <div class="row m-1 me-2 rounded-1 border border-light shadow">
            <DxFormLayout Data="@CurDmvt" ItemSizeMode="@Itemsizemode" CssClass="frm-header sis-form" onkeydown="ModifyEnterKeyPressAsTab(event);">
                <DxFormLayoutItem Caption="@Lap["Item code"]" ColSpanMd="6" CaptionCssClass="fw-bold">
                    <Template>
                        <DxTextBox @bind-Text="@CurDmvt.Ma_vt" maxlength="@tblLength["ma_vt"]" Enabled="@AllowEditMa"/>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="@Lap["Lookup code"]" ColSpanMd="6">
                    <Template>
                        <DxTextBox @bind-Text="@CurDmvt.Ma_tra_cuu" maxlength="@tblLength["ma_tra_cuu"]" Enabled="@AllowEditMode" />
                    </Template>
                </DxFormLayoutItem>
                
                <DxFormLayoutItem Caption="@Lap["Item name"]" ColSpanMd="12" CaptionCssClass="fw-bold">
                    <Template>
                        <DxTextBox @bind-Text="@CurDmvt.Ten_vt" maxlength="@tblLength["ten_vt"]" Enabled="@AllowEditMode" />
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem Caption="@Lap["Item name 2"]" ColSpanMd="12">
                    <Template>
                        <DxTextBox @bind-Text="@CurDmvt.Ten_vt2" maxlength="@tblLength["ten_vt2"]" Enabled="@AllowEditMode" />
                    </Template>
                </DxFormLayoutItem>
               
                <DxFormLayoutItem Caption="@Lap["UOM"]" ColSpanMd="6">
                    <Template>
                        <DxTextBox @bind-Text="@CurDmvt.Dvt" maxlength="@tblLength["dvt"]" Enabled="@AllowEditMode" />
                    </Template>
                </DxFormLayoutItem>

                <DxFormLayoutItem Caption="@Lap["Part number"]" ColSpanMd="6" CaptionCssClass="fw-bold">
                    <Template>
                        <DxTextBox @bind-Text="@CurDmvt.Part_no" InputCssClass="uppercase" Enabled="@AllowEditMode" />
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Item type"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmloaivt" @bind-Value="@CurDmvt.Loai_vt" AllowNull="false" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Stock item"]" BeginRow="true">
                    <div class="row m-0 p-0">
                        <DxMaskedInput @bind-Value="@CurDmvt.Vt_ton_kho"
                                       Enabled="@AllowEditMode"
                                       CssClass="col-3 m-0 p-0"
                                       Mask="[0-1]"
                                       MaskMode="@MaskMode.RegEx">
                            <DxRegExMaskProperties Placeholder="@Placeholder" />
                        </DxMaskedInput>
                        <span class="col">@Lap["0 - No, 1 - Yes, inventory tracking"]</span>
                    </div>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Valuation method"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmvtgiatk" @bind-Value="@CurDmvt.Gia_ton" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Inventory account"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmtk1" @bind-Value="@CurDmvt.Tk_vt" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Editing inventory account"]">
                    <div class="row m-0 p-0">
                        <DxMaskedInput @bind-Value="@CurDmvt.Sua_tk_vt"
                                       Enabled="@AllowEditMode"
                                       CssClass="col-3 m-0 p-0"
                                       Mask="[0-1]"
                                       MaskMode="@MaskMode.RegEx">
                            <DxRegExMaskProperties Placeholder="@Placeholder" />
                        </DxMaskedInput>
                        <span class="col">@Lap["0 - No, 1 - Yes"]</span>
                    </div>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Difference cost account"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmtk1" @bind-Value="@CurDmvt.Tk_cl_vt" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Revenue account"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmtk1" @bind-Value="@CurDmvt.Tk_dt" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["COGS account"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmtk1" @bind-Value="@CurDmvt.Tk_gv" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["Sales return account"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmtk1" @bind-Value="@CurDmvt.Tk_tl" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="6" Caption="@Lap["WIP account"]">
                    <Template>
                        <AutocompleteComponent Ma_dm="dmtk1" @bind-Value="@CurDmvt.Tk_spdd" IsEnable="@AllowEditMode" IsLangEn="@IsLangEn"></AutocompleteComponent>
                    </Template>
                </DxFormLayoutItem>
    
                <DxFormLayoutItem Caption="@Lap["Group 1/2/3"]" ColSpanMd="5" BeginRow="true">
                        <Template>
                            <DxComboBox Enabled="@AllowEditMode" NullText="@Lap["Select ..."]"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                    ListRenderMode="ListRenderMode.Entire"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    Data="@lstNhkh1"
                                    TextFieldName="@nameof(listItem.ten_item)"
                                    EditFormat="{0} {1}"
                                    ValueFieldName="@nameof(listItem.ma_item)"
                                    @bind-Value="@CurDmvt.Nh_vt1">
                                <Buttons>
                                    <DxEditorButton IconCssClass="editor-icon editor-iconadd" Tooltip="@Lap["New"]" Click="@(_ => OnAddNhkhClick())" />
                                </Buttons>
                                <Columns>
                                    <DxListEditorColumn FieldName="@nameof(listItem.ma_item)" Caption="@Lap["ID"]" Width="50px" />
                                    @if (!IsLangEn)
                                    {
                                        <DxListEditorColumn FieldName="@nameof(listItem.ten_item)" Caption="@Lap["Name"]" />
                                        <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)" Caption="@Lap["Name 2"]" />
                                    }
                                    else
                                    {
                                        <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)" Caption="@Lap["Name 2"]" />
                                        <DxListEditorColumn FieldName="@nameof(listItem.ten_item)" Caption="@Lap["Name"]" />
                                    }
                                </Columns>
                            </DxComboBox>
                        </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="4">
                    <Template>
                        <DxComboBox Enabled="@AllowEditMode" NullText="@Lap["Select ..."]"
                                    ListRenderMode="ListRenderMode.Entire"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    Data="lstNhkh2"
                                    TextFieldName="@nameof(listItem.ten_item)"
                                    EditFormat="{0} {1}"
                                    ValueFieldName="@nameof(listItem.ma_item)"
                                    @bind-Value="@CurDmvt.Nh_vt2">
                            <Buttons>
                                <DxEditorButton IconCssClass="editor-icon editor-iconadd" Tooltip="@Lap["New"]" Click="@(_ => OnAddNhkhClick())" />
                            </Buttons>
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(listItem.ma_item)" Caption="@Lap["ID"]" Width="50px" />
                                @if (!IsLangEn)
                                {
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item)" Caption="@Lap["Name"]" />
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)" Caption="@Lap["Name 2"]" />
                                }
                                else
                                {
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)" Caption="@Lap["Name 2"]" />
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item)" Caption="@Lap["Name"]" />
                                }
                            </Columns>
                        </DxComboBox>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="3">
                    <Template>
                        <DxComboBox Enabled="@AllowEditMode" NullText="@Lap["Select ..."]"
                                    ListRenderMode="ListRenderMode.Entire"
                                    FilteringMode="DataGridFilteringMode.Contains"
                                    Data="lstNhkh3"
                                    TextFieldName="@nameof(listItem.ten_item)"
                                    EditFormat="{0} {1}"
                                    ValueFieldName="@nameof(listItem.ma_item)"
                                    @bind-Value="@CurDmvt.Nh_vt3">
                            <Buttons>
                                <DxEditorButton IconCssClass="editor-icon editor-iconadd" Tooltip="@Lap["New"]" Click="@(_ => OnAddNhkhClick())" />
                            </Buttons>
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(listItem.ma_item)" Caption="@Lap["ID"]" Width="50px" />
                                @if (!IsLangEn)
                                {
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item)" Caption="@Lap["Name"]" />
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)" Caption="@Lap["Name 2"]" />
                                }
                                else
                                {
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)" Caption="@Lap["Name 2"]" />
                                    <DxListEditorColumn FieldName="@nameof(listItem.ten_item)" Caption="@Lap["Name"]" />
                                }
                            </Columns>
                        </DxComboBox>
                    </Template>
                </DxFormLayoutItem>    
                <DxFormLayoutItem Caption="@Lap["Status"]" ColSpanMd="6">
                    <Template>
                        <DxComboBox Enabled="@AllowEditMode"
                                    ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Never"
                                    Data="LSStatus"
                                    TextFieldName="Ten"
                                    ValueFieldName="Ma"
                                    @bind-Value="@CurDmvt.Status">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(Dmtk.Ma)" Caption="@Lap["ID"]" Width="50px"/>
                                <DxListEditorColumn FieldName="@nameof(Dmtk.Ten)" Caption="@Lap["Name"]"/>                    
                            </Columns>
                        </DxComboBox>
                    </Template>
                </DxFormLayoutItem>
                <DxFormLayoutItem Field="Ma_dvcs" Enabled="@AllowEditMode"
                                  Caption="@Lap["Unit"]"
                                  ColSpanMd="6">
                    <DxComboBox Data="@tblDmdvcs" Enabled="@AllowEditMode"
                                ClearButtonDisplayMode="DataEditorClearButtonDisplayMode.Auto"
                                NullText="@Lap["Select ..."]"
                                ListRenderMode="ListRenderMode.Virtual"
                                FilteringMode="DataGridFilteringMode.Contains"
                                ValueFieldName="ma_item"
                                Value="@(Converts.ToString(((ValueEditContext)context).Value))"
                                ValueChanged="@((string value) =>CurDmvt.Ma_dvcs = value)"
                                EditFormat="{1} {2}">
                        <DxListEditorColumn FieldName="@nameof(listItem.ma_item)"
                                            Caption="@Lap["ID"]"
                                            Width="50px" />
                        @if(!IsLangEn)
                        {
                        <DxListEditorColumn FieldName="@nameof(listItem.ten_item)"
                                            Caption="@Lap["Name"]" />
                        <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)"
                                            Caption="@Lap["Name 2"]" />
                        }
                        else
                        {                
                            <DxListEditorColumn FieldName="@nameof(listItem.ten_item2)"
                                            Caption="@Lap["Name 2"]" />
                            <DxListEditorColumn FieldName="@nameof(listItem.ten_item)"
                                            Caption="@Lap["Name"]" />
                        }
                    </DxComboBox>
                </DxFormLayoutItem>
                <DxFormLayoutItem ColSpanMd="12">
                    <Template>
                        <hr/>
                    </Template>
                </DxFormLayoutItem>
            </DxFormLayout>
        </div>
    </FormList>
</div>
@if(AddNhvtvisible)
{
    <EditNhvt curActionTask="ActionTask.New" ShowAdd="true" menu_id="ws.dm.04" OnClose="CloseFrmNhvt" />
}
<style>
    .editor-iconadd {             
        -webkit-mask: url("..\\Images\\Add.svg");
        mask: url("..\\Images\\Add.svg");
    }
</style>

@code {
    public bool AddNhvtvisible { get; set; }    
    private List<listItem> tblDmdvcs;
    private List<listItem> lstNhkh1;
    private List<listItem> lstNhkh2;
    private List<listItem> lstNhkh3;
    private List<listItem> lstNhkh;    
    public IEnumerable<string> Tags { get; set; }
    char Placeholder = '#';
    public Dmvt CurDmvt;      
    private string menu_id = "ws.dm.03";

    void CloseFrmNhvt()
    {
        AddNhvtvisible = false;
    } 
    protected override void OnInitialized()
    {        
        sqlTableName = "Dmvt";
        SqlTableKey = "Ma_vt";
        CheckSqlTableKey = "Ma_vt";        
        ParentPage = String.IsNullOrEmpty(ParentPage) ? "invt" : ParentPage;
        CurDmvt = new Dmvt();

        if (String.IsNullOrEmpty(Menu_id))
            Menu_id = menu_id;

        base.OnInitialized();                
    }

    protected override async Task OnInitializedAsync()
    { 
        await PageLoad();

        string strsql = "Select ma_dvcs as ma_item,ten_dvcs as ten_item,ten_dvcs2 as ten_item2 from v_dmdvcs where status = 1 order by ma_dvcs";
        tblDmdvcs = await mySqldb.Loaddata<listItem, dynamic>(strsql, new { });

        strsql = "Select ma_nh as ma_item,ten_nh as ten_item,ten_nh2 as ten_item2 from v_dmnhvt where status = 1 AND loai_nh = 1 order by ma_nh";
        lstNhkh1 = await mySqldb.Loaddata<listItem, dynamic>(strsql, new { });

        strsql = "Select ma_nh as ma_item,ten_nh as ten_item,ten_nh2 as ten_item2 from v_dmnhvt where status = 1 AND loai_nh = 2 order by ma_nh";
        lstNhkh2 = await mySqldb.Loaddata<listItem, dynamic>(strsql, new { });
        strsql = "Select ma_nh as ma_item,ten_nh as ten_item,ten_nh2 as ten_item2 from v_dmnhvt where status = 1 AND loai_nh = 3 order by ma_nh";
        lstNhkh3 = await mySqldb.Loaddata<listItem, dynamic>(strsql, new { });

        strsql = "Select ma_nh as ma_item,ten_nh as ten_item,ten_nh2 as ten_item2 from v_dmnhvt where status = 1 order by ma_nh";
        lstNhkh = await mySqldb.Loaddata<listItem, dynamic>(strsql, new { });

        strsql = "Select top 2 ma_nh as ma_item from v_dmnhvt where status = 1 order by ma_nh";
        Tags = await mySqldb.Loaddata<string, dynamic>(strsql, new { });


    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {            
            switch (curActionTask)
            {
                case ActionTask.View:
                    {
                        if (!string.IsNullOrEmpty(Ma_ma))
                            ViewDM(Ma_ma);
                        myStateMN.SetToolBar(new MyToolbar("save", false));
                        break;
                    }
                case ActionTask.Edit:
                    {
                        if (!string.IsNullOrEmpty(Ma_ma))
                            EditDM(Ma_ma);
                        break;
                    }
                case ActionTask.New:
                    {
                        CreateNewDM();
                        break;
                    }
                case ActionTask.Copy:
                    {
                        CreateCopyDM(Ma_ma);
                        break;
                    }
                default:
                    {
                        if (!string.IsNullOrEmpty(Ma_ma))
                            ViewDM(Ma_ma);
                        break;
                    }
            }        
        }
    }
    void ViewDM(string SqlTableKeyValue)
    {
        CurDmvt = new Dmvt();
        AllowEditMode = false;
        AllowEditMa = false;
        LoadData(SqlTableKeyValue);
        StateHasChanged();
    }
    void EditDM(string SqlTableKeyValue)
    {
        CurDmvt = new Dmvt();
        AllowEditMode = true;
        AllowEditMa = false;
        LoadData(SqlTableKeyValue);
        StateHasChanged();
    }
    async Task OnEdit()
    {
        AllowEditMode = true;
        curActionTask = ActionTask.Edit;
    }
    async Task OnCopy()
    {
        CreateCopyDM(CurDmvt.Ma_vt);
    }
    async Task SaveDM()
    {
        if (curActionTask == ActionTask.New)
            if (!CheckValidCode())
                return;

        if (!CheckValid())
            return;

        CurDmvt.Ma_vt = CurDmvt.Ma_vt.ToUpper().Trim();
        SqlTableKeyValue = CurDmvt.Ma_vt;
        if (curActionTask == ActionTask.New)
        {
            CurDmvt.Date = DateTime.Now.Date;
            CurDmvt.Date0 = DateTime.Now.Date;
            CurDmvt.Time = DateTime.Now.ToString("HH:MM:ss");
            CurDmvt.Time0 = DateTime.Now.ToString("HH:MM:ss");
            if (curUser != null)
            {
                CurDmvt.User_id = curUser.User_id;
                CurDmvt.User_id0 = curUser.User_id;
                CurDmvt.User_name = curUser.User_name;
                CurDmvt.User_name0 = curUser.User_name;
            }
            CheckSqlTableKeyValue = CurDmvt.Ma_vt.Trim();
            string[] strKey = CheckSqlTableKey.Split(';');
            string[] strKeyValue = CheckSqlTableKeyValue.Split(';');
            string condition = "";
            if (strKey.Length > 0)
            {
                for (int x = 0; x < strKey.Length; x++)
                {
                    condition += strKey[x] + " = '" + strKeyValue[x] + "' and ";
                }
                if (!string.IsNullOrEmpty(condition))
                    condition = condition.Substring(0,condition.Length-4);
            }
            string check = "Select " + SqlTableKey + " from " +  sqlTableName + " where " + condition;
            DataSet ds = await myDb.LoadDataset(check);
            if(ds!=null && ds.Tables[0].Rows.Count > 0)
            {
                myStateMN.SetNewThongbao(String.Format(Lap["Code [{0} ] already exists !"], SqlTableKeyValue));
                StateHasChanged();
            }
            else
            {
                await myDb.InsertOneRow<Dmvt>(CurDmvt, sqlTableName);
                myStateMN.SetNewThongbao(String.Format(Lap["Successfully added new : {0}"], SqlTableKeyValue));               
            }
        }
        else if (curActionTask == ActionTask.Edit)
        {
            CurDmvt.Date = DateTime.Now.Date;
            CurDmvt.Time = DateTime.Now.ToString("HH:MM:ss");
            if (curUser != null)
            {
                CurDmvt.User_id = curUser.User_id;
                CurDmvt.User_name = curUser.User_name;
            }
            await myDb.UpdateOneRow<Dmvt>(CurDmvt, sqlTableName, SqlTableKey, SqlTableKeyValue);
            myStateMN.SetNewThongbao(String.Format(Lap["Edit successfully : {0}"], SqlTableKeyValue));            
        } 
        // Đóng Form nhập
        if (DxWindowmodel != null)
        {
            myModal.CloseModal(DxWindowmodel);
        }

        if (ShowAdd == true)
        {
            OnClose.InvokeAsync();
        }
        else
            myNavi.NavigateTo("/" + ParentPage);
    }
    bool CheckValid()
    {        
        if (string.IsNullOrEmpty(CurDmvt.Ten_vt))
        {
            myStateMN.SetNewThongbao(Lap["No customer name entered"]);
            StateHasChanged();
            return false;
        }       
        return true;

    }
    public async Task LoadData(string SqlTableKeyValue)
    {
        string sql = "Select * from " + sqlTableName + " where " + SqlTableKey + " = '" + SqlTableKeyValue + "'";
        DataSet DsTrans = await myDb.LoadDataset(sql);
        if (DsTrans != null && DsTrans.Tables[0].Rows.Count > 0)
        {
            List<Dmvt> lsdetai = myDb.ConvertDataTable<Dmvt>(DsTrans.Tables[0]);
            if (lsdetai != null && lsdetai.Count > 0)
                CurDmvt = lsdetai[0];
        }        
    }
    public async void CreateNewDM()
    {
        CurDmvt = new Dmvt();
        CurDmvt.Status = "1";        
        CurDmvt.Ma_vt = GetNewSttDM();
        AllowEditMode = true;
        AllowEditMa = true;

        if (!String.IsNullOrEmpty(Ma_ma))
        {
            string sql = "Select Ten_vt,Ten_vt2 from " + sqlTableName + " where " + SqlTableKey + " = '" + Ma_ma + "'";
            DataSet DsTrans = await myDb.LoadDataset(sql);
            if (DsTrans != null && DsTrans.Tables[0].Rows.Count > 0)
            {
                CurDmvt.Ten_vt = DsTrans.Tables[0].Rows[0]["Ten_vt"].ToString();
                CurDmvt.Ten_vt2 = DsTrans.Tables[0].Rows[0]["Ten_vt2"].ToString();
            }
        }
        StateHasChanged();
    }
    public async void CreateCopyDM(string SqlTableKeyValue)
    {        
        CurDmvt = new Dmvt();        
        await LoadData(SqlTableKeyValue);
        
        CurDmvt.Status = "1";
        CurDmvt.Ma_vt = GetNewSttDM();
        AllowEditMode = true;
        AllowEditMa = true;
        curActionTask = ActionTask.New;
        StateHasChanged();
    }
   
    void OnAddNhkhClick()
    {
        AddNhvtvisible = true;
        StateHasChanged();
    }    
}